name: test

on:
  push:
  #   branches:
  #   - master
  # pull_request:
  #   branches:
  #   - master

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9]
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest coverage
        pip install .
    
    - name: Test with pytest
      run: |
         coverage run --source=tests -m pytest tests/test_spacelabs.py
         coverage xml
         head -n 2 coverage.xml
         COVERAGE=$(python -c "import xml.etree.ElementTree as ET; print(int(float(ET.parse('coverage.xml').getroot().attrib['line-rate']) * 100))")
         echo $COVERAGE
         COLOR=$(echo $COVERAGE | python -c "import sys; from bisect import bisect; i=bisect([0,60,70,80,80,100], int(sys.stdin.read()))-1; print(['red', 'orange', 'yellow', 'yellowgreen', 'green', 'brightgreen'][i])")
         echo $COLOR
         echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
         echo "COLOR=$COLOR" >> $GITHUB_ENV

    - if: ${{ matrix.python-version == '3.9' }}
      name: Create the coverage gist
      uses: schneegans/dynamic-badges-action@v1.0.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: 270a0114dfad9251945a146dd6d29fa6
        filename: devicely__${{ env.BRANCH }}.json
        label: Test Coverage
        message: ${{ env.COVERAGE }}
        color: ${{ env.COLOR }}